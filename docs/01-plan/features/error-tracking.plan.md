# Plan: Error Tracking 개선

> 백엔드 에러 로깅 및 추적 시스템 개선

## 1. 문제 정의

### 현재 상황
프론트엔드에서 백엔드 API 호출 시 `socket hang up` (ECONNRESET) 에러가 발생하고 있으나, 백엔드에서 어떤 에러가 발생했는지 확인이 어려움.

```
Failed to proxy http://localhost:8080/api/v1/fragments Error: socket hang up
    at Socket.socketCloseListener (node:_http_client:547:27)
    ...
  code: 'ECONNRESET'
```

### 근본 원인 분석
1. **서버 크래시 미감지**: 예외 발생 시 서버가 갑자기 종료되면 클라이언트는 `ECONNRESET`만 받음
2. **로깅 부족**: 현재 `GlobalExceptionHandler`에서 로깅이 제한적
3. **Request/Response 추적 없음**: 어떤 요청이 문제를 일으켰는지 추적 불가
4. **Correlation ID 없음**: 분산 환경에서 요청 추적 불가
5. **Startup 에러 미감지**: 서버 시작 실패 시 원인 파악 어려움

### 영향 범위
- 개발자: 디버깅 시간 증가
- 운영: 장애 원인 파악 지연
- 사용자: 불명확한 에러 메시지

## 2. 목표

### 핵심 목표
1. **모든 에러 가시화**: 발생한 모든 에러를 로그에 기록
2. **요청 추적성**: 각 요청에 고유 ID 부여 (Correlation ID)
3. **구조화된 로깅**: JSON 형식으로 로그 분석 용이하게
4. **실패 원인 명확화**: 클라이언트에게 의미 있는 에러 메시지 전달

### 성공 지표
- [ ] 모든 4xx/5xx 응답이 로그에 기록됨
- [ ] Request/Response에 Correlation ID 포함
- [ ] 스택트레이스가 로그에 완전히 기록됨
- [ ] 구조화된 JSON 로그 출력 (선택)

## 3. 범위

### In Scope
1. Request/Response 로깅 필터 추가
2. Correlation ID 생성 및 전파
3. GlobalExceptionHandler 개선
4. 로깅 설정 최적화
5. Startup 에러 핸들링 개선

### Out of Scope
- 외부 로그 수집 시스템 (ELK, Datadog 등)
- APM 도구 연동
- 알림 시스템

## 4. 기술 분석

### 현재 구조
```
┌─────────────────────────────────────────────────────────────┐
│                     Client Request                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              JwtAuthenticationFilter                         │
│              (일부 에러 로깅 있음)                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Controller                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              GlobalExceptionHandler                          │
│        (Exception 캐치, 제한적 로깅)                         │
└─────────────────────────────────────────────────────────────┘
```

### 개선 후 구조
```
┌─────────────────────────────────────────────────────────────┐
│                     Client Request                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│            RequestLoggingFilter (NEW)                        │
│    - Correlation ID 생성                                     │
│    - Request 정보 로깅                                       │
│    - MDC 설정                                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              JwtAuthenticationFilter                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Controller                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│          GlobalExceptionHandler (Enhanced)                   │
│    - 상세 스택트레이스 로깅                                  │
│    - Correlation ID 응답에 포함                              │
│    - 에러 카테고리별 로깅 레벨                               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│            ResponseLoggingFilter (NEW)                       │
│    - Response 정보 로깅                                      │
│    - 처리 시간 기록                                          │
└─────────────────────────────────────────────────────────────┘
```

### 필요 컴포넌트
| 컴포넌트 | 위치 | 역할 |
|---------|------|------|
| `RequestLoggingFilter` | pros-api | 요청 로깅, Correlation ID 생성 |
| `CorrelationIdHolder` | pros-api | MDC 기반 Correlation ID 관리 |
| `GlobalExceptionHandler` (개선) | pros-api | 상세 에러 로깅 |
| `ErrorResponse` (개선) | pros-api | Correlation ID 포함 |
| `logback-spring.xml` | pros-bootstrap | 로깅 포맷 설정 |

## 5. 구현 우선순위

### Phase 1: 핵심 로깅 개선 (필수)
1. `GlobalExceptionHandler` 개선 - 모든 예외에 대한 상세 로깅
2. logback 설정 추가 - 콘솔 출력 최적화
3. Startup 에러 핸들링

### Phase 2: 요청 추적 (권장)
4. `RequestLoggingFilter` 추가
5. Correlation ID 시스템 구현
6. ErrorResponse에 correlationId 필드 추가

### Phase 3: 고급 기능 (선택)
7. 구조화된 JSON 로깅
8. 민감 정보 마스킹

## 6. 리스크

| 리스크 | 영향 | 대응 |
|--------|------|------|
| 로깅 오버헤드 | 성능 저하 | 비동기 로깅, 샘플링 고려 |
| 민감 정보 노출 | 보안 | 마스킹 필터 적용 |
| 로그 용량 증가 | 스토리지 | 로그 레벨 분리, 롤링 설정 |

## 7. 일정

- **Phase 1**: 즉시 적용 가능
- **Phase 2**: Phase 1 완료 후
- **Phase 3**: 필요시 추가

---

**작성일**: 2026-01-31
**상태**: Draft
**다음 단계**: Design 문서 작성 → `/pdca design error-tracking`
